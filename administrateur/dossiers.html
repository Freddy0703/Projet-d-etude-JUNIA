<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des Dossiers Médicaux</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container mt-4">
    <h3>Dossiers Médicaux</h3>

    <!-- Barre de recherche et filtres -->
    <div class="row mb-3">
      <div class="col-md-5">
        <input type="text" id="searchPatient" class="form-control" placeholder="Rechercher par nom complet du patient...">
      </div>
      <div class="col-md-4">
        <input type="date" id="dateFilter" class="form-control">
      </div>
    </div>

    <!-- Tableau des dossiers -->
    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID Dossier</th>
          <th>Date de création</th>
          <th>Patient</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="dossiersTable"></tbody>
    </table>

    <!-- Navigation -->
    <div class="mt-4">
      <a href="/administrateur/patients" class="btn btn-info">Retour Patients</a>
      <a href="/administrateur/dashboard" class="btn btn-secondary">Retour Dashboard</a>
    </div>
  </div>

  <script>
    let allDossiers = [];

    // Charger les dossiers depuis l'API
    fetch('/api/admin/dossiers')
      .then(res => res.json())
      .then(data => {
        allDossiers = data;
        renderTable(allDossiers);
      });

    // Fonction pour afficher le tableau filtré
    function renderTable(dossiers) {
      const table = document.getElementById('dossiersTable');
      table.innerHTML = '';
      dossiers.forEach(d => {
        table.innerHTML += `
          <tr>
            <td>${d.idDossier}</td>
            <td>${d.dateCreation}</td>
            <td>${d.prenom} ${d.nom}</td>
            <td>
              <a href="/administrateur/examens/${d.idDossier}" class="btn btn-sm btn-primary">Voir Examens</a>
            </td>
          </tr>
        `;
      });
    }

    // Filtrage par patient et date
    document.getElementById('searchPatient').addEventListener('input', applyFilters);
    document.getElementById('dateFilter').addEventListener('change', applyFilters);

    function applyFilters() {
      const searchValue = document.getElementById('searchPatient').value.toLowerCase();
      const dateValue = document.getElementById('dateFilter').value;

      const filtered = allDossiers.filter(d => {
        const fullName = (d.prenom + ' ' + d.nom).toLowerCase();
        const matchesName = fullName.includes(searchValue);
        const matchesDate = dateValue ? d.dateCreation === dateValue : true;
        return matchesName && matchesDate;
      });

      renderTable(filtered);
    }
  </script>
</body>
</html>
