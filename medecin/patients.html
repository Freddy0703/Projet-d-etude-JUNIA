<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Patients - Médecin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container mt-4">
    <h3>Liste des Patients</h3>

    <!-- Barre de recherche et filtres -->
    <div class="row mb-3">
      <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par nom complet...">
      </div>
      <div class="col-md-3">
        <select id="sexeFilter" class="form-select">
          <option value="">Filtrer par sexe</option>
          <option value="Homme">Homme</option>
          <option value="Femme">Femme</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="text" id="nationaliteFilter" class="form-control" placeholder="Filtrer par nationalité...">
      </div>
    </div>

    <!-- Tableau des patients -->
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Prénom</th>
          <th>Nom</th>
          <th>Âge</th>
          <th>Téléphone</th>
          <th>Sexe</th>
          <th>Nationalité</th>
          <th>Dossiers</th>
        </tr>
      </thead>
      <tbody id="patientsTable"></tbody>
    </table>

    <!-- Navigation -->
    <div class="mt-4">
      <a href="/medecin/dashboard" class="btn btn-secondary">Retour Dashboard</a>
    </div>
  </div>

  <script>
    let allPatients = [];

    // Charger les patients depuis l'API
    fetch('/api/medecin/patients')
      .then(res => res.json())
      .then(data => {
        allPatients = data;
        renderTable(allPatients);
      });

    // Fonction pour afficher le tableau filtré
    function renderTable(patients) {
      const table = document.getElementById('patientsTable');
      table.innerHTML = '';
      patients.forEach(p => {
        table.innerHTML += `
          <tr>
            <td>${p.prenom}</td>
            <td>${p.nom}</td>
            <td>${p.age || ''}</td>
            <td>${p.tel || ''}</td>
            <td>${p.sexe}</td>
            <td>${p.nationalite || ''}</td>
            <td><a href="/medecin/dossiers?patient=${p.idPatient}" class="btn btn-sm btn-primary">Voir Dossiers</a></td>
          </tr>
        `;
      });
    }

    // Filtrage par recherche, sexe et nationalité
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('sexeFilter').addEventListener('change', applyFilters);
    document.getElementById('nationaliteFilter').addEventListener('input', applyFilters);

    function applyFilters() {
      const searchValue = document.getElementById('searchInput').value.toLowerCase();
      const sexeValue = document.getElementById('sexeFilter').value;
      const natValue = document.getElementById('nationaliteFilter').value.toLowerCase();

      const filtered = allPatients.filter(p => {
        const fullName = (p.prenom + ' ' + p.nom).toLowerCase();
        const matchesName = fullName.includes(searchValue);
        const matchesSexe = sexeValue ? p.sexe === sexeValue : true;
        const matchesNat = natValue ? (p.nationalite || '').toLowerCase().includes(natValue) : true;
        return matchesName && matchesSexe && matchesNat;
      });

      renderTable(filtered);
    }
  </script>
</body>
</html>
